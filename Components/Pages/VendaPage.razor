@page "/vendas"

@using Blazorise
@using Blazorise.DataGrid
@using ControleDeEstoque.DTOs.FormaDePagamentoDto
@using ControleDeEstoque.DTOs.ProdutoDto
@using ControleDeEstoque.DTOs.VendaDto
@using ControleDeEstoque.DTOs.VendaItemDto
@using ControleDeEstoque.Services.IFormaDePagamentoService
@using ControleDeEstoque.Services.IProdutoService
@using ControleDeEstoque.Services.IVendasService
@rendermode InteractiveServer

@inject IVendasService VendaService
@inject IProdutoService ProdutoService
@inject IFormaDePagamentoService FormaDePagamentoService

<PageTitle>Controle de Vendas</PageTitle>

@if (VendasDoDia == null || FormasDePagamento == null)
{
    <p><em>Carregando...</em></p>
}
else
{
    <div style="display: inline;">
        <h3 style="display: inline;">Vendas</h3>
        <h5 style="display: inline;"> | Controle de Vendas</h5>
    </div>
    <Row>
        <Column>
            <Card Margin="Margin.Is4.OnY">
                <CardBody>
                    <Div class="d-flex justify-content-end mb-2">
                        <Div>
                            <Button Color="Color.Success" Clicked="AbrirModalRegistrarVenda">Nova Venda</Button>
                        </Div>
                    </Div>
                    <DataGrid TItem="VendaDto"
                              Data="VendasDoDia"
                              Striped="true"
                              Bordered="true"
                              Hoverable="true">
                        <DataGridColumns>
                            <DataGridColumn TItem="VendaDto" Field="@nameof(VendaDto.DataVenda)" Caption="Data" DisplayFormat="{0:dd/MM/yyyy HH:mm}" />
                            <DataGridColumn TItem="VendaDto" Field="@nameof(VendaDto.MetodoPagamento)" Caption="Método de Pagamento" />
                            <DataGridNumericColumn TItem="VendaDto" Field="@nameof(VendaDto.ValorTotal)" Caption="Valor Total" DisplayFormat="{0:C}" />
                        </DataGridColumns>
                    </DataGrid>
                </CardBody>
            </Card>
        </Column>
    </Row>
}

<!-- Modal Registrar Venda -->
<Modal @ref="ModalRegistrarVenda">
    <ModalContent Size="ModalSize.Large" Centered="true">
        <ModalHeader>
            <strong>Registrar Nova Venda</strong>
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>Adicionar Produto</FieldLabel>
                <Addons>
                    <Addon AddonType="AddonType.Body">
                        <TextEdit @bind-Text="ProdutoSku" Placeholder="Digite o código do produto" />
                    </Addon>
                    <Addon AddonType="AddonType.End">
                        <Button Color="Color.Default" Clicked="AdicionarProduto">
                            <Icon Name="IconName.Search" /> Adicionar
                        </Button>
                    </Addon>
                </Addons>
            </Field>
            <Field>
                <FieldLabel>Nome do Produto</FieldLabel>
                <TextEdit @bind-Text="NomeProduto" Disabled="true" />
            </Field>
            <Field>
                <FieldLabel>Quantidade</FieldLabel>
                <NumericEdit TValue="int" @bind-Value="QuantidadeVendida" Min="1" />
            </Field>

            <Field>
                <FieldLabel>Itens Adicionados</FieldLabel>
                <DataGrid TItem="VendaItemDto" Data="ItensVendidos" Striped="true" Bordered="true">
                    <DataGridColumns>
                        <DataGridColumn TItem="VendaItemDto" Field="@nameof(VendaItemDto.ProdutoId)" Caption="Produto" />
                        <DataGridNumericColumn TItem="VendaItemDto" Field="@nameof(VendaItemDto.Quantidade)" Caption="Quantidade" />
                        <DataGridNumericColumn TItem="VendaItemDto" Field="@nameof(VendaItemDto.ValorUnitario)" Caption="Valor Unitário" DisplayFormat="{0:C}" />
                        <DataGridNumericColumn TItem="VendaItemDto" Field="@nameof(VendaItemDto.Subtotal)" Caption="Subtotal" DisplayFormat="{0:C}" />
                        <DataGridCommandColumn TItem="VendaItemDto">
                            <CommandTemplate>
                                <Button Color="Color.Danger" Clicked="() => RemoverItem(context)">
                                    <Icon Name="IconName.Clear" /> Remover
                                </Button>
                            </CommandTemplate>
                        </DataGridCommandColumn>
                    </DataGridColumns>
                </DataGrid>
            </Field>

            <Field>
                <Label for="FormaDePagamento">Forma de Pagamento</Label>
                <Select TValue="Guid" @bind-Value="NovaFormaDePagamentoId">
                    @if (FormasDePagamento != null)
                    {
                        foreach (var forma in FormasDePagamento)
                        {
                            <SelectItem Value="@forma.Id">@forma.Tipo</SelectItem>
                            NovaFormaDePagamentoId = forma.Id;
                        }
                    }
                    else
                    {
                        <SelectItem Value="default(Guid)" Disabled="true">Nenhuma forma de pagamento cadastrada</SelectItem>
                    }
                </Select>
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Success" Clicked="SalvarVenda">Salvar</Button>
            <Button Color="Color.Danger" Clicked="CancelarVenda">Cancelar</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
    private List<VendaDto> VendasDoDia = new();
    private string NomeProduto;
    private int QuantidadeVendida = 1;
    private ProdutoDto ProdutoSelecionado;
    private List<VendaItemDto> ItensVendidos = new();
    private List<FormaDePagamentoDto> FormasDePagamento;
    private Guid NovaFormaDePagamentoId;
    private string ProdutoSku;
    private Modal ModalRegistrarVenda;
    private VendaItemDto context;
    

    protected override async Task OnInitializedAsync()
    {
        FormasDePagamento = await FormaDePagamentoService.ListarFormasDePagamento();
        VendasDoDia = await VendaService.ListarVendas();
    }

    private async Task AdicionarProduto()
    {
        var produtos = await ProdutoService.ListarProdutos();
        // Find the product by SKU
        ProdutoSelecionado = produtos.FirstOrDefault(p => p.Sku == ProdutoSku);
        if (ProdutoSelecionado == null)
        {
            NomeProduto = "Produto não encontrado.";
            return;
        }

        // Use the GUID to get the product details
        ProdutoSelecionado = await ProdutoService.ListarProdutoPorId(ProdutoSelecionado.Id);
        if (ProdutoSelecionado == null)
        {
            NomeProduto = "Produto não encontrado.";
            return;
        }
        
        var item = new VendaItemDto
        {
            ProdutoId = ProdutoSelecionado.Id,
            Quantidade = QuantidadeVendida,
            ValorUnitario = ProdutoSelecionado.ValorUnitario,
            Subtotal = ProdutoSelecionado.ValorUnitario * QuantidadeVendida
        };
        ItensVendidos.Add(item);

        ProdutoSku = string.Empty;
        NomeProduto = string.Empty;
    }

    private void RemoverItem(VendaItemDto item)
    {
        ItensVendidos.Remove(item);
    }

    private async Task SalvarVenda()
    {
        ProdutoSelecionado = await ProdutoService.ListarProdutoPorId(ProdutoSelecionado.Id);
        if (ProdutoSelecionado == null)
        {
            NomeProduto = "Produto não encontrado.";
            return;
        }

        // Gerar o ID da nova venda
        var novaVendaId = Guid.NewGuid();

        // Criar a venda sem os itens primeiro, para salvar o ID no banco
        var novaVenda = new VendaDto
        {
            Id = novaVendaId, // Atribuindo o ID da nova venda
            MetodoPagamentoId = NovaFormaDePagamentoId,
            ValorTotal = ItensVendidos.Sum(i => i.Subtotal)
        };

        // Salvar a venda no banco de dados
        await VendaService.AdicionarVenda(novaVenda);

        // Agora, criar os itens de venda com o Id da venda já atribuído
        var itensVenda = ItensVendidos.Select(i => new VendaItemDto
        {
            ProdutoId = i.ProdutoId,
            Quantidade = i.Quantidade,
            ValorUnitario = i.ValorUnitario,
            VendaId = novaVendaId // Usando o ID da venda gerado para os itens
        }).ToList();

        // Adicionar os itens da venda
        foreach (var item in itensVenda)
        {
            await VendaService.AdicionarItem(item); // Assumindo que existe um método para adicionar itens de venda
        }

        // Agora que a venda e os itens foram salvos, podemos finalizar o processo
        VendasDoDia.Add(novaVenda);

        // Limpar as variáveis e estados após a venda
        ItensVendidos.Clear();
        NovaFormaDePagamentoId = Guid.Empty;
        ModalRegistrarVenda.Hide();
    }

    private void CancelarVenda()
    {
        ItensVendidos.Clear();
        NovaFormaDePagamentoId = Guid.Empty;
        ModalRegistrarVenda.Hide();
    }

    private void AbrirModalRegistrarVenda()
    {
        ModalRegistrarVenda.Show();
    }
}